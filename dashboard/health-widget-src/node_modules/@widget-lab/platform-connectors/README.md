<!-- $PublishToSwym{"swym-data":"eyJzY2hlbWEiOiJBIiwiY29tbXVuaXRpZXMiOnsiX3lmeFQ5T0JTOFNkVW5RY3FqUXdXUSI6eyJtZWRpYXMiOnt9LCJ0eXBlIjoid2lraSIsInBhcmVudElkIjoieHdwRmJQV1BReU9jR3lPeFFzM1EtQSIsIm1kNSI6ImY1Y2UzZDA3MzNkMGFlYzM1NGY4NWU1YzBiYmIwMTQxIiwiaWQiOiI3TnVlTVltWlFjNnJ3allZYkdyVExRIn19fQ=="}$ -->

# Platform Connectors

## Introduction

This package aims to:

-   ease tenants management in the platform
-   ease calls to 3DSwym webservices (CSRF token handling)
-   ease calls to 3DSpace webservices (CSRF token & Security Context handling)
-   ease calls to other 3DS webservices (retrieve service url more easely)

## What's new ? üÜï

-   Since v3.3.15, we are now able in most case to autodetect the 3DCompassURL for you (untrusted mode).

## Installation

If you never installed one of the Widget Lab component, add our npm repository to your configuration:

```bash
npm config set @widget-lab:registry https://itgit.dsone.3ds.com/api/v4/packages/npm/
npm config set "//itgit.dsone.3ds.com/api/v4/packages/npm/:_authToken" "61qKzSxnrLqyeyBy1H-o"
```

Then

```bash
npm i @widget-lab/platform-connectors
```

## Available methods

:information_source: See `index.d.ts` for more information about these functions.

| Method                     | Return type       | Description                                            |
| -------------------------- | ----------------- | ------------------------------------------------------ |
| initPlatformConnectors     | Promise\<void\>   | Initialize the module                                  |
| call3DSwym                 | Promise\<any\>    | Call a 3DSwym webservice                               |
| call3DSpace                | Promise\<any\>    | Call a 3DSpace webservice                              |
| call3DCompass              | Promise\<any\>    | Call a 3DCompass webservice                              |
| call3DWebServices          | Promise\<any\>    | Call a 3DS webservice webservice                       |
| get3DSpaceServiceUrl       | Promise\<string\> | Get 3DSpace service url                                |
| getCurrentTenantServiceUrl | Promise\<string\> | Get service url by name                                |
| getCurrentTenantServices   | Promise\<any\>    | Get list of services available in the current tenant   |
| getCurrentTenantId         | Promise\<string\> | Get the current tenant id                              |
| getCurrentTenant           | Promise\<any\>    | Get the current tenant information(name, id, services) |
| getCurrentSecurityContext  | Promise\<string\> | Get current security context                           |
| get3DSpaceCsrfToken        | Promise\<string\> | Get 3DSpace CSRF token                                 |
| getTransientTicket         | Promise\<string\> | Get 3DPassport Transient Ticket (TGT)                  |

## Usage

Before calling any other method, you must initialize the module using `initPlatformConnectors({ ... })`.

Example:

```javascript
import { initPlatformConnectors, call3DSpace } from "@widget-lab/platform-connectors";

// ...

initPlatformConnectors({
    allowTenantsSelection: true, // Allow user to select the tenant (dropdown list added to widget preferences) ?
    allowSecurityContextSelection: true // Allow user to select the security context (dropdown list added to widget preferences) ?
});

// ...

call3DSpace(SOME_3DSPACE_WEBSERVICE).then(res => {
    console.log(res);
});
```

### Untrusted Mode

> Since v3.3.15, we are now able in most case to autodetect the 3DCompassURL for you.

When running in Run your App mode, we cannot automatically retrieve platform services URL as we need the 3DCompass url to load tenants and security context.

Yet, you can still use this package by allowing users (or yourself by using the `compassURL` option in `initPlatformConnectors()` below) to manually set 3DCompass URL in widget preferences. With 3DCompass URL we are able to retrieve all available platforms and get all services URL related to them. This package will automattically provide you a textfield in the preference to fulfil the 3DCompass URL when you are in untrusted mode !

Most 3DSpace webservices need a security context, but retrieving security contexts requires the tenant id. You can give to the user the choice of the tenant by set `allowTenantsSelection` to `true`:

```javascript
initPlatformConnectors({
    allowTenantsSelection: true
    // allowSecurityContextSelection: ...,
    // compassURL: ... (Not mandatory, only if you want to set programmatically the 3DCompass URL)
});
```

### Override Security Contexts

In some rare cases, you might want to override Security Contexts to restrict available options:

```javascript
initPlatformConnectors({
    // allowTenantsSelection: ...,
    // allowSecurityContextSelection: ...,
    // compassURL: ...,
    securityContexts: ["VPLMCreator.Company Name.Default"]
});
```

**NB**: If you do not plan to use 3DSpaces webservices, you can also enhance initialization time by setting `securityContexts: []`.

### Call3DSpace method parameters

You can pass an argument to call3DSpace method to customize your call:

```javascript
call3DSpace(url, { method: "GET", data, headers = {}, type, useSecurityContext = true, useCsrf = true, ... })
```

| Parameter             | Default value | Description                                                                                    |
| --------------------- | ------------- | ---------------------------------------------------------------------------------------------- |
| method                | GET           | HTTPS method name                                                                              |
| data                  | {}            | Body of the request to send to the endpoint                                                    |
| headers               | {}            | Headers params                                                                                 |
| type                  | json          | Type of the request (application/json...)                                                      |
| useSecurityContext    | true          | Add security context inside call headers                                                       |
| useCsrf               | true          | Add token to header                                                                            |
| timeout               | 25000         | Timeout for the request in milliseconds                                                        |
| onTimeout             |               | function called if the request times out                                                       |
| onProgress            |               | Callback to monitor the request progression (see <https://xhr.spec.whatwg.org/#progressevent>) |
| returnHeader          | false         | Return the response header in addition of the body                                             |
| encodeSecurityContext | false         | URI-Encode the security context header                                                         |

### Call3DSwym method parameters

You can pass an argument to call3DSwym method to customize your call:

```javascript
call3DSwym(url, { method, data, headers = {}, type, ... })
```

| Parameter    | Default value | Description                                                                                    |
| ------------ | ------------- | ---------------------------------------------------------------------------------------------- |
| method       | GET           | HTTPS method name                                                                              |
| data         | {}            | Body of the request to send to the endpoint                                                    |
| headers      | {}            | Headers params                                                                                 |
| type         | json          | Type of the request (application/json...)                                                      |
| timeout      | 25000         | Timeout for the request in milliseconds                                                        |
| onTimeout    |               | function called if the request times out                                                       |
| onProgress   |               | Callback to monitor the request progression (see <https://xhr.spec.whatwg.org/#progressevent>) |
| returnHeader | false         | return the response header in addition of the body                                             |

### Call3DCompass method parameters

You can pass an argument to call3DCompass method to customize your call:

```javascript
call3DCompass(url, { method, data, headers = {}, type, ... })
```

| Parameter    | Default value | Description                                                                                  |
| ------------ | ------------- | -------------------------------------------------------------------------------------------- |
| method       | GET           | HTTPS method name                                                                            |
| data         | {}            | Body of the request to send to the endpoint                                                  |
| headers      | {}            | Headers params                                                                               |
| type         | json          | Type of the request (application/json...)                                                    |
| timeout      | 25000         | Timeout for the request in milliseconds                                                      |
| onTimeout    |               | function called if the request times out                                                     |
| onProgress   |               | Callback to monitor the request progression (see <https://xhr.spec.whatwg.org/#progressevent>) |
| returnHeader | false         | return the response header in addition of the body                                           |

### call3DWebServices method parameters

Be aware that this method is just a mockup of WAFData [authenticatedRequest](https://dsdoc.dsone.3ds.com/devdoc/3DEXPERIENCER2023x/en/generated/js/WebAppsFoundations-WAFData/module-DS_WAFData_WAFData.htm#.authenticatedRequest) function.

> Unlike `call3DSpace` and `call3DSwym` methods, we do not provide any csrf token & security context management. If you're trying to reach a web service that needs this type of header, you'll need to provide it manually in the `headers` parameter described below.

You can pass an argument to call3DWebServices method to customize your call:

```javascript
call3DWebServices(serviceName, webServicePath, { method: "GET", data, headers = {}, type, ... })
```

| Parameter name | Default value | Description                                                                                                                                              |
| -------------- | ------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| serviceName    |               | Name of the service that you want to reach (3DDRive, 3DPortfolio, 3DCompass...), Use `getCurrentTenantServices` method to get list of services available |
| webServicePath |               | WebService path that you want to reach                                                                                                                   |

| Option parameters name | Default value | Description                                                                                    |
| ---------------------- | ------------- | ---------------------------------------------------------------------------------------------- |
| method                 | GET           | HTTPS method name                                                                              |
| data                   | {}            | Body of the request to send to the endpoint                                                    |
| headers                | {}            | Headers params                                                                                 |
| type                   | json          | Type of the request (application/json...)                                                      |
| timeout                | 25000         | Timeout for the request in milliseconds                                                        |
| onTimeout              |               | function called if the request times out                                                       |
| onProgress             |               | Callback to monitor the request progression (see <https://xhr.spec.whatwg.org/#progressevent>) |
| returnHeader           | false         | return the response header in addition of the body                                             |

#### How to use call3DWebServices method ?

Usage example on 3DDrive Webservice:

```javascript
call3DWebServices("3DDrive", `/resources/3ddrive/v1/bos/${myFileId}?tenant=${myTenant}`);
```

#### How to use returnHeader parameter ?

In some specific cases like a call into 3DDrive webservice (because 3ddrive token is always added intot the header response), you maybe wanted to retrieve the header of the request made by the connector. So there is a parameter called `returnHeader` that is available into call3DWebServices, call3DSwym and call3DSpace method, that help you to retrieve header response of the request ( + the body data).

Usage example of `returnHeader` on 3DDrive Webservice:

```javascript
call3DWebServices("3DDrive", `/resources/3ddrive/v1/bos/ticket`, { returnHeader: true }).then(res => {
    console.log(res); /* { responseData, responseHeaders } */
});
```

### How to find 3DCompass URL

The 3DCompass base URL: having this base URL will allow to retrieve all platform services base URLs so you won't need to provide 3DSpace or 3DDrive base URLs. On cloud, it's easy to determine ; for example if the platform is  
 <https://eu1-ifwe.3dexperience.3ds.com> then the 3DCompass base URL is  
 <https://eu1-compass.3dexperience.3ds.com/enovia>. On premise, the 3DCompass URL is the same as the 3DSpace URL. Don't forget to add `/enovia` at the end of the URL !

### Handling errors

In case some calls to 3DSpace or 3DSwym fail, `platform-connectors` will simply propagate the errors received from `WAFData`.

```javascript
call3DSpace(/* ... */).catch(err => console.log(err));
/**
 * May output:
 * {
 *   error: { ... }
 *   backendresponse: { ... }
 *   response_hdrs: { ... }
 * }
 */
```

You can learn more about `WAFData` errors in the DSDoc.

## Breaking change V2.0 to V3.0

Here is the list of the big changes that were made between version 2 and 3:

-   `allowManualTenantConfigInUntrustedMode` and `allowedServiceInUntrustedMode` initPlatformConnectors options are now **deprecated**
-   3DCompass URL appears automatically and must be completed in untrusted mode to retrieve all tenants
-   Some function have been add like `getCurrentTenantServiceUrl`or `getCurrentTenantId`

## Contributing

Please follow the instructions below to contribute to the project.

### Project setup

```bash
# Clone the project and create a global symlink
# https://docs.npmjs.com/cli/v6/commands/npm-link
git clone ...
cd platform-connectors
npm link

# Create or use an existing widget and import platform-connectors
cd some-test-widget
npm link @widget-lab/platform-connectors
```

‚ö†Ô∏è Please make sure to run prettier before committing.
