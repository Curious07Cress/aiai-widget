function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

import { authenticatedRequest } from "../utils/Http";
const SERVICE_NAME = "3dcompass";
export default class Interface3DCompass {
  constructor(strategy) {
    _defineProperty(this, "loadCsrfToken", async () => {
      const serviceUrl = await this.strategy.getCurrentTenantServiceUrl(SERVICE_NAME);
      const data = await authenticatedRequest(`${serviceUrl}/resources/AppsMngt/security/csrf`);
      return data["X-DS-CSRFTOKEN"];
    });

    _defineProperty(this, "performCall", async (url, {
      method,
      data,
      headers = {},
      type,
      timeout,
      onTimeout,
      onProgress,
      returnHeader = false
    }) => {
      if (!this.csrfPromise) {
        this.csrfPromise = this.loadCsrfToken();
      }

      const serviceUrl = await this.strategy.getCurrentTenantServiceUrl(SERVICE_NAME);
      const fullUrl = `${serviceUrl}${url}`; // Manipulate headers as a Headers class : this will work in both cases where input headers are provided as Record or as Headers

      const enhancedHeaders = new Headers(headers);
      const csrfToken = await this.csrfPromise;
      enhancedHeaders.set("X-DS-CSRFTOKEN", csrfToken); // WAFData does not accept a Headers class: it has to be transformed as a Record

      const finalHeaders = {};
      Array.from(enhancedHeaders.entries()).forEach(([key, value]) => finalHeaders[key] = value);
      return authenticatedRequest(fullUrl, {
        method,
        headers: finalHeaders,
        data,
        type,
        timeout,
        onTimeout,
        onProgress,
        returnHeader
      });
    });

    _defineProperty(this, "call3DCompass", (url, options = {}) => {
      return this.performCall(url, options).catch(() => {
        this.csrfPromise = null;
        return this.performCall(url, options);
      });
    });

    this.strategy = strategy;
    this.csrfPromise = null;
  }

}