function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

import { authenticatedRequest } from "../utils/Http";
const OOTB_SWYM_SERVICE_NAME = "3DSwym";
const OOTB_SWYM_SERVICE_PATH = "/api/index/tk";
export default class Interface3DSwym {
  constructor(strategy) {
    _defineProperty(this, "resetCsrfPromise", () => {
      this.csrfPromise = this.loadCsrfToken();
    });

    _defineProperty(this, "loadCsrfToken", async () => {
      const swymUrl = await this.strategy.getCurrentTenantServiceUrl(OOTB_SWYM_SERVICE_NAME);
      const tokenUrl = `${swymUrl}${OOTB_SWYM_SERVICE_PATH}`;
      const data = await authenticatedRequest(tokenUrl);
      return data.result.ServerToken;
    });

    _defineProperty(this, "performCall", async (url, {
      method,
      data,
      headers = {},
      type,
      timeout,
      onTimeout,
      onProgress,
      returnHeader = false
    }) => {
      if (!this.csrfPromise) {
        this.resetCsrfPromise();
      }

      const swymUrl = await this.strategy.getCurrentTenantServiceUrl(OOTB_SWYM_SERVICE_NAME);
      const fullUrl = `${swymUrl}${url}`; // Manipulate headers as a Headers class : this will work in both cases where input headers are provided as Record or as Headers

      const enhancedHeaders = new Headers(headers);
      const csrfToken = await this.csrfPromise;
      enhancedHeaders.set("x-ds-swym-csrftoken", csrfToken); // WAFData does not accept a Headers class: it has to be transformed as a Record

      const finalHeaders = {};
      Array.from(enhancedHeaders.entries()).forEach(([key, value]) => finalHeaders[key] = value);
      return authenticatedRequest(fullUrl, {
        method,
        headers: finalHeaders,
        data,
        type,
        timeout,
        onTimeout,
        onProgress,
        returnHeader
      });
    });

    _defineProperty(this, "call3DSwym", (url, options = {}) => {
      return this.performCall(url, options).catch(() => {
        this.csrfPromise = null;
        return this.performCall(url, options);
      });
    });

    this.strategy = strategy;
    this.csrfPromise = null;
  }

}