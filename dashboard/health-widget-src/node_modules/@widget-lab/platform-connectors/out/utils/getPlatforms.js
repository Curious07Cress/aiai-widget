import { requirejsPromise } from "@widget-lab/3ddashboard-utils";
import { ERROR_PASSPORT_DISCONNECTED } from "../utils/constants";
const GET_PLATFORMS_ENDPOINT = "/resources/AppsMngt/api/v1/services";

const getPlatforms = async compassUrl => {
  const WAFDataPromise = requirejsPromise("DS/WAFData/WAFData");
  return new Promise((resolve, reject) => {
    WAFDataPromise.then(WAFData => {
      WAFData.authenticatedRequest(compassUrl + GET_PLATFORMS_ENDPOINT, {
        type: "json",
        onComplete: data => {
          resolve(data.platforms);
        },
        onFailure: err => {
          if (err.message === "Invalid, expired or missing CASTGC. Re-authentication required") reject(ERROR_PASSPORT_DISCONNECTED);else reject("Error while retrieving platform tenants. If running in Run your App mode, please make sure 3DCompass URL is correct. On cloud, it's easy to determine ; for example if the platform is https://eu1-ifwe.3dexperience.3ds.com then the 3DCompass base URL is https://eu1-compass.3dexperience.3ds.com/enovia. On Premise, 3DCompass URL is the same as 3DSpace URL");
        },
        onPassportError: () => {
          reject(ERROR_PASSPORT_DISCONNECTED);
        }
      });
    });
  });
};

export { getPlatforms };